<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Feed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50:  '#eef2ff',
              100: '#e0e7ff',
              200: '#c7d2fe',
              500: '#6366f1',
              600: '#5457e0',
              700: '#4f46e5',
              800: '#4338ca',
            }
          },
          boxShadow: {
            soft: '0 10px 25px -10px rgba(0,0,0,.15)',
          },
          backdropBlur: { xs: '2px' }
        }
      }
    }
  </script>
</head>
<body class="h-full bg-gradient-to-b from-brand-50 to-white text-slate-800">
  <!-- NAV -->
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-5xl px-4 py-3 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2">
        <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-brand-600 text-white font-bold">MS</span>
        <span class="font-semibold text-slate-900">Mini Social</span>
      </a>
      <nav class="flex items-center gap-2">
        <a href="/profile"
           class="rounded-lg px-3 py-1.5 text-sm text-slate-700 hover:text-slate-900 hover:bg-slate-100 transition">
          Profile
        </a>
        <a href="/logout"
           class="rounded-lg px-3 py-1.5 text-sm text-slate-700 hover:text-slate-900 hover:bg-slate-100 transition">
          Logout
        </a>
      </nav>
    </div>
  </header>

  <main class="mx-auto max-w-5xl px-4 py-8">

    <section class="mb-10">
      <form action="/create-post" method="post"
            class="rounded-2xl border border-slate-200 bg-white p-5 shadow-soft">
        <label class="block text-sm font-semibold text-slate-700 mb-2">Create a post</label>
        <div class="rounded-xl ring-1 ring-slate-300 focus-within:ring-2 focus-within:ring-brand-600 bg-white">
          <textarea
            name="postData"
            rows="3"
            placeholder="Share something with everyone…"
            class="w-full rounded-xl bg-transparent px-4 py-3 outline-none placeholder-slate-400"
          ></textarea>
        </div>
        <div class="mt-3 flex items-center justify-end gap-2">
          <button type="reset"
                  class="rounded-xl px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 transition">Clear</button>
          <input
            type="submit"
            value="Post"
            class="cursor-pointer rounded-xl bg-brand-600 px-5 py-2 text-sm font-semibold text-white hover:bg-brand-700 active:scale-95 transition"
          />
        </div>
      </form>
    </section>

    <!-- FEED -->
    <section>
      <div class="mb-4 flex items-center justify-between">
        <h2 class="text-lg font-semibold">Feed</h2>
      </div>

      <% if (!post || post.length === 0) { %>
        <div class="rounded-2xl border border-dashed border-slate-300 bg-white p-10 text-center text-slate-500">
          No posts yet. Be the first!
        </div>
      <% } %>

      <div class="space-y-4">
        <% post.forEach(post => { 
             const likes = (post.like || []);
             const youLiked = (typeof currentUser !== 'undefined' && currentUser && currentUser._id)
                              ? likes.some(l => String(l) === String(currentUser._id))
                              : false;
             const d = post && post.date ? new Date(post.date) : null;
             const user = post.userId || {};
             const avatar = user.profile ? `/images/uploads/${user.profile}` : '/images/default-avatar.png';
        %>
          <article class="rounded-2xl border border-slate-200 bg-white p-5 shadow-soft hover:shadow transition">
            <header class="mb-3 flex items-start justify-between">
              <div class="flex items-center gap-3">
                <img
                  src="<%= avatar %>"
                  alt="avatar"
                  class="h-10 w-10 rounded-xl object-cover ring-1 ring-slate-200"
                  onerror="this.src='/images/default-avatar.png'"
                />
                <div>
                  <div class="text-sm font-semibold">
                    @<%= user.username || 'unknown' %>
                  </div>
                  <div class="text-xs text-slate-500">
                    <% if (d) { %>
                      <%= d.toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' }) %>
                      ·
                      <%= d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) %>
                    <% } %>
                  </div>
                </div>
              </div>

              <% if (currentUser && user && String(currentUser._id) === String(user._id)) { %>
                <a href="/edit/<%= post._id %>"
                   class="inline-flex items-center gap-1 rounded-lg px-2 py-1 text-sm text-slate-600 hover:text-brand-700 hover:bg-brand-50 transition">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Zm14.71-9.04c.2-.2.2-.51 0-.71l-2.21-2.21a.5.5 0 0 0-.71 0l-1.83 1.83 3.75 3.75 1.99-1.66Z"/></svg>
                  Edit
                </a>
              <% } %>
            </header>

            <div class="prose prose-slate max-w-none">
              <p class="whitespace-pre-wrap text-[15px] leading-6"><%= post.postData %></p>
            </div>

            <footer class="mt-4 flex items-center justify-between">
              <div class="inline-flex items-center gap-2 text-sm text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 <%= youLiked ? 'text-brand-600' : 'text-slate-400' %>" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12.1 21.35 10 19.45C5.4 15.36 2 12.28 2 8.5 2 6 4 4 6.5 4c1.74 0 3.41.81 4.5 2.09C12.59 4.81 14.26 4 16 4 18.5 4 20.5 6 20.5 8.5c0 3.78-3.4 6.86-8 10.95l-0.4.36Z"/>
                </svg>
                <span><%= likes.length %> Likes</span>
              </div>

              <a href="/like/<%= post._id %>"
                 class="inline-flex items-center gap-2 rounded-xl border px-3 py-1.5 text-sm transition
                        <%= youLiked ? 'border-brand-600 text-brand-700 bg-brand-50 hover:bg-brand-100' : 'border-slate-300 text-slate-700 hover:border-brand-500 hover:text-brand-700' %>">
                <%= youLiked ? 'Unlike' : 'Like' %>
              </a>
            </footer>
          </article>
        <% }) %>
      </div>
    </section>
  </main>

  <footer class="mt-12 border-t border-slate-200 bg-white/70 backdrop-blur">
    <div class="mx-auto max-w-5xl px-4 py-6 text-sm text-slate-500">
      © <%= new Date().getFullYear() %> Mini Social
    </div>
  </footer>
</body>
</html>
